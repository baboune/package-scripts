name:    "ruby"
version: "2.1.0"

sources [
  { url: "https://s3.amazonaws.com/apcera-sources/ruby/ruby-2.1.0.tar.gz",
    sha256: "3538ec1f6af96ed9deb04e0965274528162726cc9ba3625dcf23648df872d09d" },
  { url: "https://apcera-sources.s3.amazonaws.com/ruby/yaml-0.1.4.tar.gz",
    sha256: "7bf81554ae5ab2d9b6977da398ea789722e0db75b86bffdaeb4e66d961de6a37" },
  { url: "https://s3.amazonaws.com/apcera-sources/ruby/rubygems-2.2.0.tgz",
    sha256: "c6257efcc4ed283a88f5e3ea703d3715e24d8ef0355186a5b2ccb34e8a267902" },
  { url: "https://apcera-sources.s3.amazonaws.com/ruby/bundler-1.5.1.gem",
    sha256: "53bbc1b911d60dc5eb581a02411a46028165dbba193e0c7c407a53bdc7ef288f" },
]

build_depends [ { package: "build-essential" } ]
depends       [ { os: "linux" } ]
provides      [ { runtime: "ruby-2.1" },
                { runtime: "ruby-2.1.0" } ]

environment { "PATH": "/opt/apcera/ruby-2.1.0/bin:$PATH" }

build (
      export BUILDPATH=`pwd`
      export INSTALLPATH="/opt/apcera/ruby-2.1.0"

      tar xzvf yaml-0.1.4.tar.gz
      (
          cd yaml-0.1.4
          ./configure --disable-shared --with-pic
          make
      )

      tar xzvf ruby-2.1.0.tar.gz
      (
        cd ruby-2.1.0
        export LDFLAGS="-L${BUILDPATH}/yaml-0.1.4/src/.libs $LDFLAGS"
        export CPPFLAGS="-I${BUILDPATH}/yaml-0.1.4/include $CPPFLAGS"
        ./configure --prefix=${INSTALLPATH} --enable-shared --disable-install-doc
        make
        sudo make install
      )

      tar zxvf rubygems-2.2.0.tgz
      (
        cd rubygems-2.2.0
        sudo ${INSTALLPATH}/bin/ruby setup.rb
      )

      sudo ${INSTALLPATH}/bin/gem install bundler-1.5.1.gem --no-ri --no-rdoc
)
